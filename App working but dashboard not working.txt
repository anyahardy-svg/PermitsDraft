import React, { useState } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  ScrollView,
  StyleSheet,
  Alert,
  Switch,
  FlatList
} from 'react-native';

const PermitManagementApp = () => {
  const [currentScreen, setCurrentScreen] = useState('dashboard');
  const [permits, setPermits] = useState([
    {
      id: 'PTW-001',
      type: 'Hot Work',
      description: 'Welding repairs on conveyor frame',
      requestedBy: 'John Smith',
      location: 'Processing Plant A',
      status: 'pending_approval',
      priority: 'high',
      submittedDate: '2025-01-15',
      assignedApprover: 'jane.doe@company.com'
    },
    {
      id: 'PTW-002', 
      type: 'Confined Space',
      description: 'Tank cleaning and inspection',
      requestedBy: 'Mike Johnson',
      location: 'Storage Area B',
      status: 'pending_inspection',
      priority: 'high',
      submittedDate: '2025-01-14',
      assignedApprover: 'bob.wilson@company.com'
    },
    {
      id: 'PTW-003',
      type: 'Electrical',
      description: 'Panel maintenance',
      requestedBy: 'Sarah Davis',
      location: 'Control Room',
      status: 'active',
      priority: 'medium',
      approvedDate: '2025-01-13',
      expiryDate: '2025-01-16'
    }
  ]);

  const [siteConfig, setSiteConfig] = useState({
    permitIssuers: [
      { name: 'Jane Doe', email: 'jane.doe@company.com', role: 'Safety Manager' },
      { name: 'Bob Wilson', email: 'bob.wilson@company.com', role: 'Operations Manager' }
    ],
    highRiskTasks: ['Hot Work', 'Confined Space', 'Working at Height'],
    autoInspectionRequired: true
  });

  const [formData, setFormData] = useState({
    permitNumber: '',
    workDescription: '',
    location: '',
    requestedBy: '',
    department: '',
    startDate: '',
    endDate: '',
    startTime: '',
    endTime: '',
    priority: 'medium',
    specializedPermits: {
      hotWork: { required: false, controls: '', questionnaire: {} },
      confinedSpace: { required: false, controls: '', questionnaire: {} },
      workingAtHeight: { required: false, controls: '', questionnaire: {} },
      electrical: { required: false, controls: '', questionnaire: {} },
      excavation: { required: false, controls: '', questionnaire: {} },
      lifting: { required: false, controls: '', questionnaire: {} },
      blasting: { required: false, controls: '', questionnaire: {} },
      plantServicing: { required: false, controls: '', questionnaire: {} },
      stripping: { required: false, controls: '', questionnaire: {} },
      surveying: { required: false, controls: '', questionnaire: {} },
      conveyorServicing: { required: false, controls: '', questionnaire: {} }
    },
    singleHazards: {
      slip: { present: false, controls: '' },
      trip: { present: false, controls: '' },
      fall: { present: false, controls: '' },
      crush: { present: false, controls: '' },
      cut: { present: false, controls: '' },
      burn: { present: false, controls: '' },
      chemical: { present: false, controls: '' },
      electrical: { present: false, controls: '' },
      noise: { present: false, controls: '' },
      vibration: { present: false, controls: '' },
      dust: { present: false, controls: '' },
      fumes: { present: false, controls: '' }
    },
    jsea: {
      taskSteps: [],
      overallRiskRating: 'medium',
      additionalPrecautions: ''
    }
  });

  const [expandedSections, setExpandedSections] = useState({
    general: true,
    specialized: false,
    hazards: false,
    jsea: false
  });

  // Complete questionnaires for each specialized permit
  const permitQuestionnaires = {
    confinedSpace: [
      { id: 'isolations', text: 'Are all isolations necessary completed?', type: 'yesno', required: true },
      { id: 'training', text: 'Are all workers entering the confined space trained and competent to perform the required task within the confined space as well as entering the confined space? NO CONFINED SPACE TRAINING = NO ENTRY', type: 'yesno', required: true },
      { id: 'medical_check', text: 'All workers checked for any potential medical, health, psychological conditions that might pose a risk, prior to entry.', type: 'yesno', required: true },
      { id: 'atmosphere_testing', text: 'Atmosphere testing arranged (O2, CO, H2S and flammables standard test requirement) - ensure gas testing equipment is within calibration and appropriate for the task', type: 'yesno', required: true },
      { id: 'other_gases', text: 'Are any other toxic gases or asphyxiants to be tested?', type: 'yesno_text', textLabel: 'If yes, record type of gas' },
      { id: 'ventilation', text: 'Is ventilation of the confined space required?', type: 'yesno_text', textLabel: 'Describe controls' },
      { id: 'engulfment', text: 'Is there a possibility of engulfment, drowning or overhead hazards?', type: 'yesno_text', textLabel: 'If yes, describe any other requirements' },
      { id: 'pressure', text: 'Is there a possibility of extreme suction, pressure or flow occurring while people are in this confined space?', type: 'yesno_text', textLabel: 'If yes, describe controls' },
      { id: 'access_egress', text: 'Is the access and egress to the confined space restricted, difficult or hazardous?', type: 'yesno_text', textLabel: 'If yes, outline precautions to take' },
      { id: 'barrier', text: 'Barrier to always be placed over the access point when workers leave the area.', type: 'yesno', required: true },
      { id: 'vehicles', text: 'Are vehicles or combustion engines likely to be a hazard?', type: 'yesno_text', textLabel: 'If yes, describe controls' },
      { id: 'harnesses', text: 'Are safety harnesses and a method of extraction required?', type: 'yesno', note: 'If yes, Review the Fall Arrest Equipment Checklist.' },
      { id: 'communication_method', text: 'Method of communication in case of emergency with entrants into confined space', type: 'yesno_text', textLabel: 'Describe communication method (Phone/Radio/Audible Signal/Visual Signal/Rope Signal)' },
      { id: 'safety_watch_name', text: 'Safety Watch Name assigned', type: 'text', required: true },
      { id: 'emergency_contact', text: 'Site Manager/Supervisor in case of emergency name', type: 'text', required: true }
    ],
    
    hotWork: [
      { id: 'workshop_alternative', text: 'Can the hot work be done in an approved hot work area such as the workshop?', type: 'text', required: true },
      { id: 'flammable_materials', text: 'Is there flammable or combustible substances/material evident, including dry vegetation within 10m of the hot work, in containers, piping systems, drains, equipment in the area, or directly below the area?', type: 'yesno_text', textLabel: 'If yes, describe removal/purging/covering controls' },
      { id: 'ignition_conveyance', text: 'Is it possible for ignition sources from hot work to be conveyed by conveyors, ducting, airflow or wind to combustible materials?', type: 'yesno', required: true },
      { id: 'conveyors_nearby', text: 'Are there conveyors, rubber lined chutes and poly deck screens in the immediate area and/or below any hot work?', type: 'yesno_text', textLabel: 'If yes, describe fire protection measures (fire blankets, wet sacks, hose down etc.)' },
      { id: 'wet_surfaces', text: 'Does floors and surface areas need to be wetted down?', type: 'yesno', required: true },
      { id: 'flammable_gases', text: 'Are flammable gases present in the area?', type: 'yesno_text', textLabel: 'If yes, describe gas testing requirements and results', note: 'Gas test required if yes' },
      { id: 'confined_space', text: 'Is hot work being undertaken in a confined space?', type: 'yesno_text', textLabel: 'If yes, list additional precautions and confirm Confined Space permit completed', note: 'Confined Space permit also required if yes' },
      { id: 'hdpe_welding', text: 'Is High Density Polyethylene pipe being welded using electrofusion?', type: 'yesno_text', textLabel: 'If yes, describe blanking procedures and cooling time requirements', note: 'Blank off open end and follow manufacturer cooling times' },
      { id: 'grinders', text: 'Are disk grinders being used?', type: 'yesno_text', textLabel: 'If yes, confirm double eye protection and qualified operator for 9" grinders', note: 'Double eye protection required' },
      { id: 'wash_down', text: 'On processing plants, wash down hose in place and pumps turned on before commencing hot work.', type: 'yesno', required: true },
      { id: 'fire_extinguishers', text: 'Adequate and suitable fire extinguishers available on the job? A minimum of 3.5kg CO2 or dry powder fire extinguishers must be on hand.', type: 'yesno', required: true },
      { id: 'hot_marking', text: 'Did you mark all work items as HOT if someone else is working in the same area?', type: 'yesno', required: true },
      { id: 'flashback_arrestors', text: 'Are the correct flash back arrestors fitted to all gas bottles?', type: 'yesno', required: true },
      { id: 'alarm_plan', text: 'Is there a plan to raise the alarm if needed?', type: 'yesno_text', textLabel: 'Describe alarm procedure and communication method', required: true }
    ],

    electrical: [
      { id: 'ewrb_licenses', text: 'Do all the workers engaged in the electrical work have current Electrical Worker Registration Board licences? Take copies for your records. No EWRB licence = No Work!', type: 'yesno', required: true },
      { id: 'sops_attached', text: 'Attach all relevant SOPs or switching procedures to the work permit.', type: 'yesno', required: true },
      { id: 'isolation_requirements', text: 'Isolation requirements completed? Test and prove all isolations. Personal locks to be used and in place during the job.', type: 'yesno_text', textLabel: 'Describe isolation requirements and lock placement', required: true },
      { id: 'signage', text: 'Signage required to be placed by job to warn of hazard?', type: 'yesno_text', textLabel: 'Describe signage type and placement' },
      { id: 'ladder_required', text: 'Will a ladder be required? If yes, non-metallic ladders to be used in switchyards and around live equipment.', type: 'yesno_text', textLabel: 'Confirm non-metallic ladder type and inspection status' },
      { id: 'cordon_area', text: 'Area of work to be cordoned off.', type: 'yesno_text', textLabel: 'Describe cordoning method and boundaries' },
      { id: 'switchyard_secured', text: 'Switchyard to be kept secured.', type: 'yesno', required: true },
      { id: 'hv_gloves', text: 'High voltage gloves to be worn when switching.', type: 'yesno', required: true },
      { id: 'ppe', text: 'Usual PPE of; high viz gear/flame retardant overalls or clothing, safety boots, safety glasses and hardhat worn.', type: 'yesno', required: true },
      { id: 'oil_spillage', text: 'Oil spillage kit available for work on transformers or oil filled switch gear.', type: 'yesno', required: true },
      { id: 'work_requirements', text: 'List any special work requirements and other work instructions or attach work plan', type: 'yesno_text', textLabel: 'Describe special requirements and work plan details' },
      { id: 'competent_personnel', text: 'All personnel undertaking this work are suitably competent (or supervised) to perform the required tasks?', type: 'yesno', required: true },
      { id: 'environmental', text: 'Consider: Are there any other environmental matters?', type: 'yesno_text', textLabel: 'If yes, describe environmental considerations and precautions' },
      { id: 'communication', text: 'Communication: Who needs to be advised or notified? Consider: Production, other site personnel and external agencies', type: 'yesno_text', textLabel: 'Describe communication plan and notification list', required: true },
      { id: 'take5', text: 'Take 5 - Any other hazards and controls required?', type: 'yesno_text', textLabel: 'Describe additional hazards and control measures' },
      { id: 'job_completion', text: 'Job Completion: Any special requirements at the closure of the job, before handing permit back for sign off?', type: 'yesno_text', textLabel: 'If yes, describe completion requirements' }
    ],

    workingAtHeight: [
      { id: 'trained_competent', text: 'Are all workers undertaking the task trained and competent in work at heights?', type: 'yesno', required: true },
      { id: 'fitness', text: 'Are all persons fit for work at height? No persons are suffering from any ailment, illness or physical condition that could put any person at risk during work at height.', type: 'yesno', required: true },
      { id: 'fall_prevention', text: 'Best fall prevention methods assessed and put in place?', type: 'yesno_text', textLabel: 'Describe fall prevention methods implemented', required: true },
      { id: 'protection_system', text: 'Fall Protection System that will be used', type: 'yesno_text', textLabel: 'Specify: Total Restraint/Fall Restraint/Work Positioning/Limited Free Fall Arrest/Free Fall Arrest', required: true },
      { id: 'safety_equipment', text: 'Specify Safety harnesses system/helmet/fall protection equipment to be used', type: 'text', required: true },
      { id: 'anchor_points', text: 'Specify the anchor point(s)', type: 'text', required: true },
      { id: 'fall_arrest_checklist', text: 'Mandatory completion of the Fall Arrest Equipment Checklist if harnesses and lanyards are used.', type: 'yesno', required: true },
      { id: 'falling_objects', text: 'Provision made to prevent objects from falling below, such as screening.', type: 'yesno_text', textLabel: 'Describe object fall prevention measures' },
      { id: 'tool_count', text: 'Tool count completed before and after work?', type: 'yesno', required: true },
      { id: 'overhead_lines', text: 'Will work at height be conducted within 4 meters of overhead lines? All work closer than 4 meters to overhead conductors must be authorized by the network operator.', type: 'yesno_text', textLabel: 'If yes, attach network operator approval and describe safety measures', note: 'Network operator approval required if within 4m' },
      { id: 'emergency_retrieval', text: 'Retrieval emergency plans/procedures, method of relief from suspension trauma required when fall arrest', type: 'yesno_text', textLabel: 'Describe emergency retrieval plan and suspension trauma relief procedures', required: true },
      { id: 'safety_watch', text: 'Safety watch required? Safety Watch must be present if harness is in use.', type: 'yesno_text', textLabel: 'Name safety watch person and describe their specific duties', required: true }
    ],

    // Basic questionnaires for other permit types
    excavation: [
      { id: 'before_you_dig', text: 'Before you dig notification completed?', type: 'yesno', required: true },
      { id: 'underground_services', text: 'Underground services identified and marked?', type: 'yesno_text', textLabel: 'Describe services and marking method', required: true },
      { id: 'shoring_required', text: 'Is shoring or slope protection required?', type: 'yesno_text', textLabel: 'Describe shoring/slope protection measures' },
      { id: 'competent_person', text: 'Competent person assigned to supervise excavation?', type: 'text', required: true },
      { id: 'emergency_egress', text: 'Emergency egress planned for workers in excavation?', type: 'yesno_text', textLabel: 'Describe egress plan', required: true }
    ],

    lifting: [
      { id: 'lift_plan', text: 'Lift plan completed and approved?', type: 'yesno', required: true },
      { id: 'crane_inspection', text: 'Crane pre-use inspection completed?', type: 'yesno', required: true },
      { id: 'operator_competency', text: 'Crane operator competency verified?', type: 'yesno_text', textLabel: 'Operator name and certification details', required: true },
      { id: 'exclusion_zone', text: 'Exclusion zone established around crane?', type: 'yesno_text', textLabel: 'Describe exclusion zone boundaries and controls', required: true },
      { id: 'load_capacity', text: 'Load within crane capacity limits?', type: 'yesno_text', textLabel: 'Load weight and crane capacity', required: true }
    ],

    blasting: [
      { id: 'blast_permit', text: 'Blast permit obtained from authorities?', type: 'yesno', required: true },
      { id: 'licensed_personnel', text: 'Licensed shot firer assigned?', type: 'text', required: true },
      { id: 'exclusion_zone', text: 'Blast exclusion zone established and communicated?', type: 'yesno_text', textLabel: 'Describe exclusion zone and communication method', required: true },
      { id: 'vibration_monitoring', text: 'Vibration monitoring equipment in place?', type: 'yesno', required: true },
      { id: 'weather_conditions', text: 'Weather conditions suitable for blasting?', type: 'yesno_text', textLabel: 'Current weather assessment', required: true }
    ],

    plantServicing: [
      { id: 'lockout_tagout', text: 'Lockout/tagout procedures implemented?', type: 'yesno_text', textLabel: 'Describe LOTO procedure and energy isolation', required: true },
      { id: 'competent_technician', text: 'Competent technician assigned for servicing?', type: 'text', required: true },
      { id: 'service_manual', text: 'Manufacturer service manual available?', type: 'yesno', required: true },
      { id: 'spare_parts', text: 'Correct spare parts and tools available?', type: 'yesno_text', textLabel: 'List key parts and tools required' },
      { id: 'restart_procedure', text: 'Plant restart procedure documented?', type: 'yesno_text', textLabel: 'Describe restart sequence and checks', required: true }
    ],

    stripping: [
      { id: 'environmental_clearance', text: 'Environmental clearance obtained?', type: 'yesno', required: true },
      { id: 'archaeology_survey', text: 'Archaeological survey completed if required?', type: 'yesno_text', textLabel: 'Survey results and any restrictions' },
      { id: 'equipment_inspection', text: 'Stripping equipment pre-start inspection completed?', type: 'yesno', required: true },
      { id: 'dust_control', text: 'Dust suppression measures in place?', type: 'yesno_text', textLabel: 'Describe dust control methods', required: true },
      { id: 'traffic_management', text: 'Traffic management plan implemented?', type: 'yesno_text', textLabel: 'Describe traffic control measures', required: true }
    ],

    surveying: [
      { id: 'survey_plan', text: 'Survey plan and methodology approved?', type: 'yesno', required: true },
      { id: 'qualified_surveyor', text: 'Qualified surveyor assigned to task?', type: 'text', required: true },
      { id: 'equipment_calibration', text: 'Survey equipment calibration current?', type: 'yesno', required: true },
      { id: 'site_access', text: 'Safe site access routes established?', type: 'yesno_text', textLabel: 'Describe access routes and safety measures', required: true },
      { id: 'communication', text: 'Communication plan with operations established?', type: 'yesno_text', textLabel: 'Describe communication method and frequency', required: true }
    ],

    conveyorServicing: [
      { id: 'conveyor_isolation', text: 'Conveyor fully isolated and locked out?', type: 'yesno_text', textLabel: 'Describe isolation points and LOTO procedure', required: true },
      { id: 'belt_condition', text: 'Belt condition assessed before work?', type: 'yesno_text', textLabel: 'Describe belt condition and any defects noted' },
      { id: 'lifting_equipment', text: 'Appropriate lifting equipment available for belt handling?', type: 'yesno_text', textLabel: 'List lifting equipment and capacity', required: true },
      { id: 'emergency_stops', text: 'Emergency stop systems tested and operational?', type: 'yesno', required: true },
      { id: 'restart_procedure', text: 'Conveyor restart procedure and safety checks documented?', type: 'yesno_text', textLabel: 'Describe restart sequence and safety verifications', required: true }
    ]
  };

  const specializedPermitTypes = [
    { key: 'hotWork', label: 'Hot Work Permit', description: 'Welding, cutting, grinding, brazing' },
    { key: 'confinedSpace', label: 'Confined Space Entry', description: 'Tanks, vessels, pits, manholes' },
    { key: 'workingAtHeight', label: 'Working at Height', description: 'Ladders, scaffolds, rooftops' },
    { key: 'electrical', label: 'Electrical Work', description: 'Live electrical work, isolation' },
    { key: 'excavation', label: 'Excavation and Demolition', description: 'Digging, trenching, demolition work' },
    { key: 'lifting', label: 'Lifting with Crane or HIAB', description: 'Cranes, hoists, lifting equipment' },
    { key: 'blasting', label: 'Marking, Drilling & Blasting', description: 'Explosive work, quarry operations' },
    { key: 'plantServicing', label: 'Mobile and Fixed Plant Servicing', description: 'Equipment maintenance and repair' },
    { key: 'stripping', label: 'Stripping Work', description: 'Site preparation, overburden removal' },
    { key: 'surveying', label: 'Surveying and Pedestrian Access', description: 'Survey work, pedestrian access to operational areas' },
    { key: 'conveyorServicing', label: 'Conveyor Servicing', description: 'Conveyor belt replacement and maintenance' }
  ];

  const singleHazardTypes = [
    { key: 'slip', label: 'Slip Hazard', description: 'Wet surfaces, spills' },
    { key: 'trip', label: 'Trip Hazard', description: 'Cables, uneven surfaces' },
    { key: 'fall', label: 'Fall Hazard', description: 'Open edges, holes' },
    { key: 'crush', label: 'Crush Hazard', description: 'Heavy objects, machinery' },
    { key: 'cut', label: 'Cut Hazard', description: 'Sharp edges, blades' },
    { key: 'burn', label: 'Burn Hazard', description: 'Hot surfaces, steam' },
    { key: 'chemical', label: 'Chemical Exposure', description: 'Skin/eye contact, inhalation' },
    { key: 'electrical', label: 'Electrical Hazard', description: 'Live circuits, static' },
    { key: 'noise', label: 'Noise Exposure', description: 'Loud machinery, tools' },
    { key: 'vibration', label: 'Vibration Exposure', description: 'Power tools, machinery' },
    { key: 'dust', label: 'Dust Exposure', description: 'Particulates, debris' },
    { key: 'fumes', label: 'Fume Exposure', description: 'Welding, chemical fumes' }
  ];

  const handleSpecializedPermitChange = (permitType, field, value) => {
    setFormData(prev => ({
      ...prev,
      specializedPermits: {
        ...prev.specializedPermits,
        [permitType]: {
          ...prev.specializedPermits[permitType],
          [field]: value
        }
      }
    }));
  };

  const handleSingleHazardChange = (hazardType, field, value) => {
    setFormData(prev => ({
      ...prev,
      singleHazards: {
        ...prev.singleHazards,
        [hazardType]: {
          ...prev.singleHazards[hazardType],
          [field]: value
        }
      }
    }));
  };

  const handleQuestionnaireResponse = (permitType, questionId, value) => {
    setFormData(prev => ({
      ...prev,
      specializedPermits: {
        ...prev.specializedPermits,
        [permitType]: {
          ...prev.specializedPermits[permitType],
          questionnaire: {
            ...prev.specializedPermits[permitType].questionnaire,
            [questionId]: value
          }
        }
      }
    }));
  };

  const addJSEAStep = () => {
    setFormData(prev => ({
      ...prev,
      jsea: {
        ...prev.jsea,
        taskSteps: [...prev.jsea.taskSteps, { 
          step: '', 
          hazards: '', 
          controls: '', 
          riskLevel: 'medium' 
        }]
      }
    }));
  };

  const updateJSEAStep = (index, field, value) => {
    setFormData(prev => ({
      ...prev,
      jsea: {
        ...prev.jsea,
        taskSteps: prev.jsea.taskSteps.map((step, i) => 
          i === index ? { ...step, [field]: value } : step
        )
      }
    }));
  };

  const removeJSEAStep = (index) => {
    setFormData(prev => ({
      ...prev,
      jsea: {
        ...prev.jsea,
        taskSteps: prev.jsea.taskSteps.filter((_, i) => i !== index)
      }
    }));
  };

  const toggleSection = (section) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };

  const getPriorityColor = (priority) => {
    switch(priority) {
      case 'high': return '#EF4444';
      case 'medium': return '#F59E0B';
      case 'low': return '#10B981';
      default: return '#6B7280';
    }
  };

  const getStatusColor = (status) => {
    switch(status) {
      case 'pending_approval': return '#F59E0B';
      case 'pending_inspection': return '#EF4444';
      case 'active': return '#10B981';
      case 'completed': return '#6B7280';
      default: return '#6B7280';
    }
  };

  const getStatusText = (status) => {
    switch(status) {
      case 'pending_approval': return 'Pending Approval';
      case 'pending_inspection': return 'Needs Inspection';
      case 'active': return 'Active';
      case 'completed': return 'Completed';
      default: return status;
    }
  };

  const getRiskColor = (level) => {
    switch(level) {
      case 'low': return '#10B981';
      case 'medium': return '#F59E0B';
      case 'high': return '#EF4444';
      default: return '#6B7280';
    }
  };

  const getDashboardCounts = () => {
    return {
      pendingApproval: permits.filter(p => p.status === 'pending_approval').length,
      pendingInspection: permits.filter(p => p.status === 'pending_inspection').length,
      active: permits.filter(p => p.status === 'active').length,
      completed: permits.filter(p => p.status === 'completed').length
    };
  };

  const renderQuestionnaireItem = (permitType, question) => {
    const currentValue = formData.specializedPermits[permitType].questionnaire[question.id] || '';
    
    switch (question.type) {
      case 'yesno':
        return (
          <View key={question.id} style={styles.questionContainer}>
            <Text style={styles.questionText}>
              {question.text}
              {question.required && <Text style={styles.required}> *</Text>}
            </Text>
            {question.note && (
              <Text style={styles.noteText}>{question.note}</Text>
            )}
            <View style={styles.radioGroup}>
              {['yes', 'no', 'na'].map(option => (
                <TouchableOpacity
                  key={option}
                  style={styles.radioOption}
                  onPress={() => handleQuestionnaireResponse(permitType, question.id, option)}
                >
                  <View style={[
                    styles.radioCircle,
                    currentValue === option && styles.radioSelected
                  ]} />
                  <Text style={styles.radioLabel}>{option.toUpperCase()}</Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>
        );
        
      case 'yesno_text':
        const isYesSelected = currentValue === 'yes' || currentValue.startsWith('yes|');
        return (
          <View key={question.id} style={styles.questionContainer}>
            <Text style={styles.questionText}>
              {question.text}
              {question.required && <Text style={styles.required}> *</Text>}
            </Text>
            {question.note && (
              <Text style={styles.noteText}>{question.note}</Text>
            )}
            <View style={styles.radioGroup}>
              {['yes', 'no', 'na'].map(option => (
                <TouchableOpacity
                  key={option}
                  style={styles.radioOption}
                  onPress={() => {
                    if (option === 'yes') {
                      handleQuestionnaireResponse(permitType, question.id, 'yes|');
                    } else {
                      handleQuestionnaireResponse(permitType, question.id, option);
                    }
                  }}
                >
                  <View style={[
                    styles.radioCircle,
                    (currentValue === option || (option === 'yes' && isYesSelected)) && styles.radioSelected
                  ]} />
                  <Text style={styles.radioLabel}>{option.toUpperCase()}</Text>
                </TouchableOpacity>
              ))}
            </View>
            {isYesSelected && (
              <View style={styles.textInputContainer}>
                <Text style={styles.textLabel}>{question.textLabel}:</Text>
                <TextInput
                  style={styles.detailTextInput}
                  multiline
                  numberOfLines={3}
                  value={currentValue.includes('|') ? currentValue.split('|')[1] : ''}
                  onChangeText={(text) => handleQuestionnaireResponse(permitType, question.id, `yes|${text}`)}
                  placeholder="Provide details..."
                />
              </View>
            )}
          </View>
        );
        
      case 'text':
        return (
          <View key={question.id} style={styles.questionContainer}>
            <Text style={styles.questionText}>
              {question.text}
              {question.required && <Text style={styles.required}> *</Text>}
            </Text>
            <TextInput
              style={styles.detailTextInput}
              multiline
              numberOfLines={3}
              value={currentValue}
              onChangeText={(text) => handleQuestionnaireResponse(permitType, question.id, text)}
              placeholder="Enter response..."
            />
          </View>
        );
        
      default:
        return null;
    }
  };

  const submitPermit = () => {
    const newPermit = {
      id: `PTW-${String(permits.length + 1).padStart(3, '0')}`,
      type: Object.keys(formData.specializedPermits).find(key => formData.specializedPermits[key].required) || 'General',
      description: formData.workDescription,
      requestedBy: formData.requestedBy,
      location: formData.location,
      status: 'pending_approval',
      priority: formData.priority,
      submittedDate: new Date().toISOString().split('T')[0],
      assignedApprover: siteConfig.permitIssuers[0]?.email || 'admin@company.com'
    };

    setPermits([...permits, newPermit]);
    Alert.alert('Permit Submitted', `Permit ${newPermit.id} submitted for approval`, [
      { text: 'OK', onPress: () => setCurrentScreen('dashboard') }
    ]);
  };

  const renderDashboard = () => {
    const counts = getDashboardCounts();
    
    return (
      <ScrollView style={styles.container}>
        <View style={styles.header}>
          <Text style={styles.title}>Permit Management Dashboard</Text>
        </View>

        <View style={styles.dashboardGrid}>
          <TouchableOpacity 
            style={[styles.dashboardCard, { borderLeftColor: '#F59E0B' }]}
            onPress={() => setCurrentScreen('pending_approval')}
          >
            <Text style={styles.cardNumber}>{counts.pendingApproval}</Text>
            <Text style={styles.cardLabel}>Pending Approval</Text>
          </TouchableOpacity>

          <TouchableOpacity 
            style={[styles.dashboardCard, { borderLeftColor: '#EF4444' }]}
            onPress={() => setCurrentScreen('pending_inspection')}
          >
            <Text style={styles.cardNumber}>{counts.pendingInspection}</Text>
            <Text style={styles.cardLabel}>Needs Inspection</Text>
          </TouchableOpacity>

          <TouchableOpacity 
            style={[styles.dashboardCard, { borderLeftColor: '#10B981' }]}
            onPress={() => setCurrentScreen('active')}
          >
            <Text style={styles.cardNumber}>{counts.active}</Text>
            <Text style={styles.cardLabel}>Active Permits</Text>
          </TouchableOpacity>

          <TouchableOpacity 
            style={[styles.dashboardCard, { borderLeftColor: '#6B7280' }]}
            onPress={() => setCurrentScreen('completed')}
          >
            <Text style={styles.cardNumber}>{counts.completed}</Text>
            <Text style={styles.cardLabel}>Completed</Text>
          </TouchableOpacity>
        </View>

        <TouchableOpacity 
          style={styles.primaryButton}
          onPress={() => setCurrentScreen('new_permit')}
        >
          <Text style={styles.primaryButtonText}>Create New Permit</Text>
        </TouchableOpacity>
      </ScrollView>
    );
  };

  const renderNewPermit = () => {
    return (
      <ScrollView style={styles.container}>
        <View style={styles.header}>
          <TouchableOpacity onPress={() => setCurrentScreen('dashboard')}>
            <Text style={styles.backButton}>← Back</Text>
          </TouchableOpacity>
          <Text style={styles.title}>New Permit Request</Text>
        </View>

        <View style={styles.section}>
          <TouchableOpacity 
            style={styles.sectionHeader}
            onPress={() => toggleSection('general')}
          >
            <Text style={styles.sectionTitle}>General Information</Text>
            <Text style={styles.expandIcon}>{expandedSections.general ? '▼' : '▶'}</Text>
          </TouchableOpacity>
          
          {expandedSections.general && (
            <View style={styles.sectionContent}>
              <Text style={styles.label}>Work Description</Text>
              <TextInput
                style={[styles.input, styles.textArea]}
                multiline
                numberOfLines={3}
                value={formData.workDescription}
                onChangeText={(text) => setFormData({...formData, workDescription: text})}
                placeholder="Describe the work to be performed..."
              />
              
              <Text style={styles.label}>Location</Text>
              <TextInput
                style={styles.input}
                value={formData.location}
                onChangeText={(text) => setFormData({...formData, location: text})}
                placeholder="Work location"
              />
              
              <Text style={styles.label}>Requested By</Text>
              <TextInput
                style={styles.input}
                value={formData.requestedBy}
                onChangeText={(text) => setFormData({...formData, requestedBy: text})}
                placeholder="Your name"
              />

              <Text style={styles.label}>Department</Text>
              <TextInput
                style={styles.input}
                value={formData.department}
                onChangeText={(text) => setFormData({...formData, department: text})}
                placeholder="Department/Team"
              />
            </View>
          )}
        </View>

        <View style={styles.section}>
          <TouchableOpacity 
            style={[styles.sectionHeader, styles.dangerHeader]}
            onPress={() => toggleSection('specialized')}
          >
            <Text style={[styles.sectionTitle, styles.dangerTitle]}>Specialized Permits</Text>
            <Text style={styles.expandIcon}>{expandedSections.specialized ? '▼' : '▶'}</Text>
          </TouchableOpacity>
          
          {expandedSections.specialized && (
            <View style={styles.sectionContent}>
              {specializedPermitTypes.map(permit => (
                <View key={permit.key} style={styles.permitCard}>
                  <View style={styles.permitHeader}>
                    <Switch
                      value={formData.specializedPermits[permit.key].required}
                      onValueChange={(value) => handleSpecializedPermitChange(permit.key, 'required', value)}
                    />
                    <View style={styles.permitInfo}>
                      <Text style={styles.permitLabel}>{permit.label}</Text>
                      <Text style={styles.permitDescription}>{permit.description}</Text>
                    </View>
                  </View>
                  
                  {formData.specializedPermits[permit.key].required && (
                    <View style={styles.permitDetails}>
                      <Text style={styles.label}>Additional Controls & Precautions:</Text>
                      <TextInput
                        style={[styles.input, styles.textArea]}
                        multiline
                        numberOfLines={2}
                        placeholder="Describe specific controls, equipment, or precautions required..."
                        value={formData.specializedPermits[permit.key].controls}
                        onChangeText={(text) => handleSpecializedPermitChange(permit.key, 'controls', text)}
                      />
                      
                      {permitQuestionnaires[permit.key] && (
                        <View style={styles.questionnaireSection}>
                          <Text style={styles.questionnaireTitle}>{permit.label} Checklist:</Text>
                          <ScrollView style={styles.questionnaireScroll} nestedScrollEnabled>
                            {permitQuestionnaires[permit.key].map(question => 
                              renderQuestionnaireItem(permit.key, question)
                            )}
                          </ScrollView>
                        </View>
                      )}
                    </View>
                  )}
                </View>
              ))}
            </View>
          )}
        </View>

        <View style={styles.section}>
          <TouchableOpacity 
            style={[styles.sectionHeader, styles.warningHeader]}
            onPress={() => toggleSection('hazards')}
          >
            <Text style={[styles.sectionTitle, styles.warningTitle]}>Single Hazard Assessment</Text>
            <Text style={styles.expandIcon}>{expandedSections.hazards ? '▼' : '▶'}</Text>
          </TouchableOpacity>
          
          {expandedSections.hazards && (
            <View style={styles.sectionContent}>
              {singleHazardTypes.map(hazard => (
                <View key={hazard.key} style={styles.permitCard}>
                  <View style={styles.permitHeader}>
                    <Switch
                      value={formData.singleHazards[hazard.key].present}
                      onValueChange={(value) => handleSingleHazardChange(hazard.key, 'present', value)}
                    />
                    <View style={styles.permitInfo}>
                      <Text style={styles.permitLabel}>{hazard.label}</Text>
                      <Text style={styles.permitDescription}>{hazard.description}</Text>
                    </View>
                  </View>
                  
                  {formData.singleHazards[hazard.key].present && (
                    <View style={styles.permitDetails}>
                      <Text style={styles.label}>Controls & Mitigation:</Text>
                      <TextInput
                        style={[styles.input, styles.textArea]}
                        multiline
                        numberOfLines={2}
                        placeholder="How will this hazard be controlled or mitigated..."
                        value={formData.singleHazards[hazard.key].controls}
                        onChangeText={(text) => handleSingleHazardChange(hazard.key, 'controls', text)}
                      />
                    </View>
                  )}
                </View>
              ))}
            </View>
          )}
        </View>

        <View style={styles.section}>
          <TouchableOpacity 
            style={[styles.sectionHeader, styles.infoHeader]}
            onPress={() => toggleSection('jsea')}
          >
            <Text style={[styles.sectionTitle, styles.infoTitle]}>Job Safety & Environmental Analysis (JSEA)</Text>
            <Text style={styles.expandIcon}>{expandedSections.jsea ? '▼' : '▶'}</Text>
          </TouchableOpacity>
          
          {expandedSections.jsea && (
            <View style={styles.sectionContent}>
              <TouchableOpacity style={styles.addButton} onPress={addJSEAStep}>
                <Text style={styles.addButtonText}>Add Task Step</Text>
              </TouchableOpacity>
              
              {formData.jsea.taskSteps.map((step, index) => (
                <View key={index} style={styles.jseaStep}>
                  <View style={styles.stepHeader}>
                    <Text style={styles.stepTitle}>Step {index + 1}</Text>
                    <TouchableOpacity onPress={() => removeJSEAStep(index)}>
                      <Text style={styles.removeButton}>Remove</Text>
                    </TouchableOpacity>
                  </View>
                  
                  <Text style={styles.label}>Task Description</Text>
                  <TextInput
                    style={styles.input}
                    value={step.step}
                    onChangeText={(text) => updateJSEAStep(index, 'step', text)}
                    placeholder="Describe the task step..."
                  />
                  
                  <Text style={styles.label}>Potential Hazards</Text>
                  <TextInput
                    style={[styles.input, styles.textArea]}
                    multiline
                    numberOfLines={2}
                    value={step.hazards}
                    onChangeText={(text) => updateJSEAStep(index, 'hazards', text)}
                    placeholder="What could go wrong during this step..."
                  />
                  
                  <Text style={styles.label}>Control Measures</Text>
                  <TextInput
                    style={[styles.input, styles.textArea]}
                    multiline
                    numberOfLines={2}
                    value={step.controls}
                    onChangeText={(text) => updateJSEAStep(index, 'controls', text)}
                    placeholder="How will the hazards be controlled..."
                  />
                  
                  <Text style={styles.label}>Risk Level (After Controls)</Text>
                  <View style={styles.riskButtons}>
                    {['low', 'medium', 'high'].map(level => (
                      <TouchableOpacity
                        key={level}
                        style={[
                          styles.riskButton,
                          { backgroundColor: step.riskLevel === level ? getRiskColor(level) : '#E5E7EB' }
                        ]}
                        onPress={() => updateJSEAStep(index, 'riskLevel', level)}
                      >
                        <Text style={[
                          styles.riskButtonText,
                          { color: step.riskLevel === level ? 'white' : '#374151' }
                        ]}>
                          {level.toUpperCase()}
                        </Text>
                      </TouchableOpacity>
                    ))}
                  </View>
                </View>
              ))}
            </View>
          )}
        </View>

        <View style={styles.submitSection}>
          <TouchableOpacity style={styles.draftButton}>
            <Text style={styles.draftButtonText}>Save Draft</Text>
          </TouchableOpacity>
          <TouchableOpacity style={styles.submitButton} onPress={submitPermit}>
            <Text style={styles.submitButtonText}>Submit for Approval</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    );
  };

  switch(currentScreen) {
    case 'dashboard':
      return renderDashboard();
    case 'new_permit':
      return renderNewPermit();
    default:
      return renderDashboard();
  }
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#F9FAFB',
  },
  header: {
    backgroundColor: '#2563EB',
    padding: 20,
    paddingTop: 50,
    flexDirection: 'row',
    alignItems: 'center',
  },
  title: {
    fontSize: 20,
    fontWeight: 'bold',
    color: 'white',
    flex: 1,
  },
  backButton: {
    color: 'white',
    fontSize: 16,
    marginRight: 15,
  },
  dashboardGrid: {
    padding: 16,
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
  },
  dashboardCard: {
    backgroundColor: 'white',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    width: '48%',
    borderLeftWidth: 4,
    elevation: 2,
  },
  cardNumber: {
    fontSize: 32,
    fontWeight: 'bold',
    color: '#111827',
  },
  cardLabel: {
    fontSize: 16,
    fontWeight: '600',
    color: '#374151',
    marginTop: 4,
  },
  primaryButton: {
    backgroundColor: '#2563EB',
    margin: 16,
    padding: 16,
    borderRadius: 8,
    alignItems: 'center',
  },
  primaryButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '600',
  },
  section: {
    margin: 16,
    backgroundColor: 'white',
    borderRadius: 8,
    overflow: 'hidden',
    elevation: 2,
  },
  sectionHeader: {
    backgroundColor: '#F3F4F6',
    padding: 16,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  dangerHeader: {
    backgroundColor: '#FEF2F2',
  },
  warningHeader: {
    backgroundColor: '#FFFBEB',
  },
  infoHeader: {
    backgroundColor: '#EFF6FF',
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: '600',
    color: '#374151',
  },
  dangerTitle: {
    color: '#DC2626',
  },
  warningTitle: {
    color: '#D97706',
  },
  infoTitle: {
    color: '#2563EB',
  },
  expandIcon: {
    fontSize: 16,
    color: '#6B7280',
  },
  sectionContent: {
    padding: 16,
  },
  label: {
    fontSize: 14,
    fontWeight: '500',
    color: '#374151',
    marginBottom: 4,
    marginTop: 12,
  },
  input: {
    borderWidth: 1,
    borderColor: '#D1D5DB',
    borderRadius: 6,
    padding: 12,
    fontSize: 16,
    backgroundColor: 'white',
  },
  textArea: {
    height: 80,
    textAlignVertical: 'top',
  },
  permitCard: {
    borderWidth: 1,
    borderColor: '#E5E7EB',
    borderRadius: 8,
    padding: 16,
    marginBottom: 16,
    backgroundColor: '#F9FAFB',
  },
  permitHeader: {
    flexDirection: 'row',
    alignItems: 'flex-start',
  },
  permitInfo: {
    flex: 1,
    marginLeft: 12,
  },
  permitLabel: {
    fontSize: 16,
    fontWeight: '600',
    color: '#111827',
  },
  permitDescription: {
    fontSize: 14,
    color: '#6B7280',
    marginTop: 4,
  },
  permitDetails: {
    marginTop: 16,
    paddingTop: 16,
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
  },
  questionnaireSection: {
    marginTop: 16,
    paddingTop: 16,
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
  },
  questionnaireTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#111827',
    marginBottom: 12,
  },
  questionnaireScroll: {
    maxHeight: 400,
  },
  questionContainer: {
    backgroundColor: '#F3F4F6',
    padding: 12,
    borderRadius: 6,
    marginBottom: 8,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  questionText: {
    fontSize: 14,
    fontWeight: '500',
    color: '#374151',
    marginBottom: 8,
  },
  required: {
    color: '#EF4444',
  },
  noteText: {
    fontSize: 12,
    color: '#6B7280',
    fontStyle: 'italic',
    marginBottom: 8,
  },
  radioGroup: {
    flexDirection: 'row',
    justifyContent: 'flex-start',
  },
  radioOption: {
    flexDirection: 'row',
    alignItems: 'center',
    marginRight: 20,
  },
  radioCircle: {
    height: 20,
    width: 20,
    borderRadius: 10,
    borderWidth: 2,
    borderColor: '#D1D5DB',
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: 6,
  },
  radioSelected: {
    borderColor: '#2563EB',
    backgroundColor: '#2563EB',
  },
  radioLabel: {
    fontSize: 14,
    color: '#374151',
  },
  textInputContainer: {
    marginTop: 8,
  },
  textLabel: {
    fontSize: 14,
    fontWeight: '500',
    color: '#6B7280',
    marginBottom: 4,
  },
  detailTextInput: {
    borderWidth: 1,
    borderColor: '#D1D5DB',
    borderRadius: 6,
    padding: 8,
    fontSize: 14,
    backgroundColor: 'white',
    textAlignVertical: 'top',
    minHeight: 60,
  },
  addButton: {
    backgroundColor: '#2563EB',
    padding: 12,
    borderRadius: 6,
    alignItems: 'center',
    marginBottom: 16,
  },
  addButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '600',
  },
  jseaStep: {
    backgroundColor: '#F9FAFB',
    padding: 16,
    borderRadius: 8,
    marginBottom: 16,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  stepHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  stepTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#111827',
  },
  removeButton: {
    color: '#EF4444',
    fontSize: 14,
    fontWeight: '500',
  },
  riskButtons: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginTop: 8,
  },
  riskButton: {
    paddingVertical: 8,
    paddingHorizontal: 16,
    borderRadius: 6,
    minWidth: 80,
    alignItems: 'center',
  },
  riskButtonText: {
    fontSize: 12,
    fontWeight: '600',
  },
  submitSection: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    padding: 16,
    backgroundColor: 'white',
    margin: 16,
    borderRadius: 8,
    elevation: 2,
  },
  draftButton: {
    flex: 0.45,
    padding: 12,
    borderWidth: 1,
    borderColor: '#D1D5DB',
    borderRadius: 6,
    alignItems: 'center',
  },
  draftButtonText: {
    color: '#374151',
    fontSize: 16,
    fontWeight: '600',
  },
  submitButton: {
    flex: 0.45,
    padding: 12,
    backgroundColor: '#2563EB',
    borderRadius: 6,
    alignItems: 'center',
  },
  submitButtonText: {
    color: 'white',
    fontSize: 16,
    fontWeight: '600',
  },
  permitListContainer: {
    padding: 16,
  },
  permitListCard: {
    backgroundColor: 'white',
    borderRadius: 8,
    padding: 16,
    marginBottom: 12,
    elevation: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.22,
    shadowRadius: 2.22,
  },
  permitListHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  permitId: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#111827',
  },
  statusBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 12,
  },
  statusText: {
    color: 'white',
    fontSize: 12,
    fontWeight: '600',
  },
  permitType: {
    fontSize: 14,
    fontWeight: '600',
    color: '#374151',
    marginBottom: 4,
  },
  permitDescription: {
    fontSize: 14,
    color: '#6B7280',
    marginBottom: 8,
  },
  permitDetails: {
    marginBottom: 8,
  },
  detailText: {
    fontSize: 12,
    color: '#9CA3AF',
    marginBottom: 2,
  },
  priorityIndicator: {
    position: 'absolute',
    top: 8,
    right: 8,
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 8,
  },
  priorityText: {
    color: 'white',
    fontSize: 10,
    fontWeight: 'bold',
  },
  emptyState: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 60,
  },
  emptyStateText: {
    fontSize: 16,
    color: '#9CA3AF',
    fontStyle: 'italic',
  },
});

export default PermitManagementApp;